---
import { LOCALES, useTranslations, type Lang } from "@/i18n";
import Layout from "@/layouts/Base.astro";
import PageHeadline from "@/components/PageHeadline.astro";
import { Image } from "astro:assets";
import { getCollection } from "astro:content";

const locale = Astro.currentLocale as Lang;
const t = useTranslations(locale);
const { category } = Astro.params;

const allPosts = (await getCollection("blog")).filter(
    (post) => post.id.split("/")[0] === locale,
);

// 筛选包含当前分类的文章
const posts = allPosts
    .filter((post) => post.data.categories?.includes(category))
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const title = t({
    ja: `カテゴリー: ${category}`,
    en: `Category: ${category}`,
    "zh-cn": `分类: ${category}`,
    ar: `التصنيف: ${category}`,
});

const backText = t({
    ja: "すべてのカテゴリーを見る",
    en: "View all categories",
    "zh-cn": "查看所有分类",
    ar: "عرض جميع التصنيفات",
});

const postsCountText = t({
    ja: `${posts.length}件の記事`,
    en: `${posts.length} post${posts.length !== 1 ? "s" : ""}`,
    "zh-cn": `${posts.length} 篇文章`,
    ar: `${posts.length} مقال`,
});

export const getStaticPaths = async () => {
    const posts = await getCollection("blog");
    const paths: { params: { lang: string; category: string } }[] = [];

    for (const lang of Object.keys(LOCALES)) {
        const langPosts = posts.filter(
            (post) => post.id.split("/")[0] === lang,
        );
        const categories = [
            ...new Set(langPosts.flatMap((post) => post.data.categories || [])),
        ];

        for (const category of categories) {
            paths.push({ params: { lang, category } });
        }
    }

    return paths;
};
---

<Layout {title}>
    <PageHeadline {title} />

    <div class="category-header">
        <a href={`/${locale}/categories/`} class="back-link">
            <span class="material-icons-sharp">arrow_back</span>
            {backText}
        </a>
        <span class="posts-count">{postsCountText}</span>
    </div>

    <ul class="posts-grid">
        {
            posts.map((post) => {
                const [, ...id] = post.id.split("/");
                return (
                    <li class="post-card">
                        <a href={`/${locale}/blog/${id.join("/")}/`}>
                            {post.data.cover && (
                                <div class="post-cover">
                                    <Image
                                        src={post.data.cover}
                                        alt={post.data.title}
                                    />
                                </div>
                            )}
                            <div class="post-content">
                                <h2 class="post-title">{post.data.title}</h2>
                                <p class="post-desc">{post.data.description}</p>
                                <div class="post-meta">
                                    <time class="post-date">
                                        {post.data.date.toLocaleDateString(
                                            locale,
                                            {
                                                year: "numeric",
                                                month: "long",
                                                day: "numeric",
                                            },
                                        )}
                                    </time>
                                    {post.data.tags &&
                                        post.data.tags.length > 0 && (
                                            <div class="post-tags">
                                                {post.data.tags
                                                    .slice(0, 2)
                                                    .map((tag) => (
                                                        <span class="tag">
                                                            {tag}
                                                        </span>
                                                    ))}
                                            </div>
                                        )}
                                </div>
                            </div>
                        </a>
                    </li>
                );
            })
        }
    </ul>
</Layout>

<style>
    .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-block: var(--sp-m);
        padding: var(--sp-s) var(--sp-m);
        background: color-mix(in srgb, var(--color-accent) 15%, transparent);
        border-radius: 8px;
    }

    .back-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--color-theme);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .back-link:hover {
        opacity: 0.8;
        transform: translateX(-2px);
    }

    .back-link .material-icons-sharp {
        font-size: 1.2rem;
    }

    .posts-count {
        color: color-mix(in srgb, var(--color-main) 60%, transparent);
        font-size: 0.9rem;
    }

    .posts-grid {
        display: grid;
        gap: var(--sp-m);
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .post-card {
        background: var(--color-base);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid color-mix(in srgb, var(--color-main) 10%, transparent);
        transition: all 0.3s ease;
    }

    .post-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px
            color-mix(in srgb, var(--color-main) 10%, transparent);
        border-color: var(--color-theme);
    }

    .post-card a {
        display: block;
        text-decoration: none;
        color: inherit;
    }

    .post-cover {
        aspect-ratio: 16 / 9;
        overflow: hidden;
    }

    .post-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .post-card:hover .post-cover img {
        transform: scale(1.05);
    }

    .post-content {
        padding: var(--sp-m);
    }

    .post-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
        color: var(--color-main);
        line-height: 1.4;
    }

    .post-desc {
        font-size: 0.9rem;
        color: color-mix(in srgb, var(--color-main) 70%, transparent);
        margin: 0 0 0.75rem 0;
        line-height: 1.6;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .post-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .post-date {
        font-size: 0.8rem;
        color: color-mix(in srgb, var(--color-main) 50%, transparent);
    }

    .post-tags {
        display: flex;
        gap: 0.25rem;
    }

    .tag {
        font-size: 0.75rem;
        padding: 0.15rem 0.5rem;
        background: color-mix(in srgb, var(--color-theme) 15%, transparent);
        border-radius: 12px;
        color: var(--color-theme);
    }

    @media (max-width: 600px) {
        .category-header {
            flex-direction: column;
            gap: 0.5rem;
            text-align: center;
        }

        .posts-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
